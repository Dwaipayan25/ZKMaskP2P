import{readFile as Y,stat as Re}from"fs/promises";import V from"path";import be from"gzip-js";import Ce from"ignore-walk";import Te from"tar";import Se from"tar-js";var P=class{constructor(e){this.config=e}};import M from"axios";import{File as Z}from"buffer";import{FormData as ee}from"formdata-node";var A=process.env.BROWSER_BUILD?window.File:Z,T=process.env.BROWSER_BUILD?window.FormData:ee;var S=class extends Error{url;status;statusText;body;request;constructor(e,r,o){super(o),this.name="ApiError",this.url=r.url,this.status=r.status,this.statusText=r.statusText,this.body=r.body,this.request=e}};var F=class extends Error{constructor(e){super(e),this.name="CancelError"}get isCancelled(){return!0}},I=class{#t;#r;#e;#o;#i;#n;#s;constructor(e){this.#t=!1,this.#r=!1,this.#e=!1,this.#o=[],this.#i=new Promise((r,o)=>{this.#n=r,this.#s=o;let i=c=>{this.#t||this.#r||this.#e||(this.#t=!0,this.#n?.(c))},s=c=>{this.#t||this.#r||this.#e||(this.#r=!0,this.#s?.(c))},a=c=>{this.#t||this.#r||this.#e||this.#o.push(c)};return Object.defineProperty(a,"isResolved",{get:()=>this.#t}),Object.defineProperty(a,"isRejected",{get:()=>this.#r}),Object.defineProperty(a,"isCancelled",{get:()=>this.#e}),e(i,s,a)})}get[Symbol.toStringTag](){return"Cancellable Promise"}then(e,r){return this.#i.then(e,r)}catch(e){return this.#i.catch(e)}finally(e){return this.#i.finally(e)}cancel(){if(!(this.#t||this.#r||this.#e)){if(this.#e=!0,this.#o.length)try{for(let e of this.#o)e()}catch(e){console.warn("Cancellation threw an error",e);return}this.#o.length=0,this.#s?.(new F("Request aborted"))}}get isCancelled(){return this.#e}};var z=t=>t!=null,B=t=>typeof t=="string",K=t=>B(t)&&t!=="",J=t=>typeof t=="object"&&typeof t.type=="string"&&typeof t.stream=="function"&&typeof t.arrayBuffer=="function"&&typeof t.constructor=="function"&&typeof t.constructor.name=="string"&&/^(Blob|File)$/.test(t.constructor.name)&&/^(Blob|File)$/.test(t[Symbol.toStringTag]),te=t=>t instanceof T,re=t=>t>=200&&t<300,oe=t=>{try{return btoa(t)}catch{return Buffer.from(t).toString("base64")}},ie=t=>{let e=[],r=(i,s)=>{e.push(`${encodeURIComponent(i)}=${encodeURIComponent(String(s))}`)},o=(i,s)=>{z(s)&&(Array.isArray(s)?s.forEach(a=>{o(i,a)}):typeof s=="object"?Object.entries(s).forEach(([a,c])=>{o(`${i}[${a}]`,c)}):r(i,s))};return Object.entries(t).forEach(([i,s])=>{o(i,s)}),e.length>0?`?${e.join("&")}`:""},se=(t,e)=>{let r=t.ENCODE_PATH||encodeURI,o=e.url.replace("{api-version}",t.VERSION).replace(/{(.*?)}/g,(s,a)=>e.path?.hasOwnProperty(a)?r(String(e.path[a])):s),i=`${t.BASE}${o}`;return e.query?`${i}${ie(e.query)}`:i},ne=t=>{if(t.formData){if(t.formData instanceof T)return t.formData;let e=new T,r=(o,i)=>{B(i)||J(i)?e.append(o,i):e.append(o,JSON.stringify(i))};return Object.entries(t.formData).filter(([o,i])=>z(i)).forEach(([o,i])=>{Array.isArray(i)?i.forEach(s=>r(o,s)):r(o,i)}),e}},k=async(t,e)=>typeof e=="function"?e(t):e,ae=async(t,e,r)=>{let o=await k(e,t.TOKEN),i=await k(e,t.USERNAME),s=await k(e,t.PASSWORD),a=await k(e,t.HEADERS),c=r&&"getHeaders"in r&&typeof r?.getHeaders=="function"&&r?.getHeaders()||{},u=Object.entries({Accept:"application/json",...a,...e.headers,...c}).filter(([p,n])=>z(n)).reduce((p,[n,l])=>({...p,[n]:String(l)}),{});if(K(o)&&(u.Authorization=`Bearer ${o}`),K(i)&&K(s)){let p=oe(`${i}:${s}`);u.Authorization=`Basic ${p}`}return e.body&&(e.mediaType?u["Content-Type"]=e.mediaType:J(e.body)?u["Content-Type"]=e.body.type||"application/octet-stream":B(e.body)?u["Content-Type"]="text/plain":te(e.body)||(u["Content-Type"]="application/json")),u},pe=t=>{if(t.body)return t.body},le=async(t,e,r,o,i,s,a,c)=>{let u=M.CancelToken.source(),p={url:r,headers:s,data:o??i,method:e.method,withCredentials:t.WITH_CREDENTIALS,cancelToken:u.token,responseType:e.responseType};a(()=>u.cancel("The user aborted a request."));try{return await c.request(p)}catch(n){let l=n;if(l.response)return l.response;throw n}},ce=(t,e)=>{if(e){let r=t.headers[e];if(B(r))return r}},ue=t=>{if(t.status!==204)return t.data},me=(t,e)=>{let o={400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable",...t.errors}[e.status];if(o)throw new S(t,e,o);if(!e.ok){let i=e.status??"unknown",s=e.statusText??"unknown",a=(()=>{try{return JSON.stringify(e.body,null,2)}catch{return}})();throw new S(t,e,`Generic Error: status: ${i}; status text: ${s}; body: ${a}`)}},G=(t,e,r=M)=>new I(async(o,i,s)=>{let a=Date.now(),c=()=>{let n=Date.now()-a;if(n<1e3)return`${n} ms`;let l=n/1e3;if(l<60)return`${l.toFixed(2)} s`;let g=l/60;return g<60?`${g.toFixed(2)} m`:`${(g/60).toFixed(2)} h`},u=se(t,e),p=`${e.method} ${u}`;try{let n=ne(e),l=pe(e),g=await ae(t,e,n);if(!s.isCancelled){t.logger?.debug(`${p} requested`);let d=await le(t,e,u,l,n,g,s,r),R=ue(d),h=ce(d,e.responseHeader),y={url:u,ok:re(d.status),status:d.status,statusText:d.statusText,body:h??R},C=`${p} ${d.status} ${d.statusText} (${c()})`;!y.body||typeof y.body=="string"?t.logger?.debug(`${C} - ${y.body||"<empty-body>"}`):e.responseType==="stream"?t.logger?.debug(`${C} - <streaming-response>`):e.responseType==="blob"?t.logger?.debug(`${C} - <blob-response>`):t.logger?.debug(y.body,C),me(e,y),o(y.body)}}catch(n){let l=n instanceof Error?n.message:"Unknown error";t.logger?.debug(`${p} ERROR (${c()}) - ${l}`),i(n)}});var L=class extends P{constructor(e){super(e)}request(e){return G(this.config,e)}};var x=class{constructor(e){this.httpRequest=e}apikeyGenerate(e){return this.httpRequest.request({method:"POST",url:"/api/apikey/generate",body:e,mediaType:"application/json",errors:{401:"Unauthorized",412:"Precondition Failed"}})}apikeyGenerateWithAuth(e){return this.httpRequest.request({method:"POST",url:"/api/v1/apikey/generate",query:{name:e},errors:{412:"Precondition Failed"}})}apikeyList(){return this.httpRequest.request({method:"GET",url:"/api/v1/apikey/list",errors:{500:"Internal Server Error"}})}apikeyDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/apikey/{apikey_id}/delete",path:{apikey_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}};var O=class{constructor(e){this.httpRequest=e}circuitCreate(e){return this.httpRequest.request({method:"POST",url:"/api/v1/circuit/create",formData:e,mediaType:"multipart/form-data",errors:{412:"Precondition Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented"}})}circuitList(){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/list",errors:{500:"Internal Server Error"}})}circuitDetail(e,r=!0){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/detail",path:{circuit_id:e},query:{include_verification_key:r},errors:{404:"Not Found",500:"Internal Server Error"}})}circuitDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/circuit/{circuit_id}/delete",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}circuitProofs(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/proofs",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}proofCreate(e,r){return this.httpRequest.request({method:"POST",url:"/api/v1/circuit/{circuit_id}/prove",path:{circuit_id:e},formData:r,mediaType:"application/x-www-form-urlencoded",errors:{404:"Not Found",412:"Precondition Failed",501:"Not Implemented"}})}};var w=class{constructor(e){this.httpRequest=e}circuitDownload(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/download",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"},responseType:process.env.BROWSER_BUILD?"blob":"stream"})}circuitSmartContractVerifier(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/smart_contract_verifier",path:{circuit_id:e},errors:{404:"Not Found",412:"Precondition Failed",500:"Internal Server Error",501:"Not Implemented"}})}passwordChangeWithJwtAuth(e){return this.httpRequest.request({method:"POST",url:"/api/v1/password/change",formData:e,mediaType:"application/x-www-form-urlencoded",errors:{422:"Unprocessable Entity"}})}proofList(){return this.httpRequest.request({method:"GET",url:"/api/v1/proof/list",errors:{500:"Internal Server Error"}})}sindriManifestSchema(){return this.httpRequest.request({method:"GET",url:"/api/v1/sindri-manifest-schema.json"})}teamMe(){return this.httpRequest.request({method:"GET",url:"/api/v1/team/me"})}userMeWithJwtAuth(){return this.httpRequest.request({method:"GET",url:"/api/v1/user/me"})}};var q=class{constructor(e){this.httpRequest=e}proofDetail(e,r=!0,o=!0,i=!1,s=!0){return this.httpRequest.request({method:"GET",url:"/api/v1/proof/{proof_id}/detail",path:{proof_id:e},query:{include_proof:r,include_public:o,include_smart_contract_calldata:i,include_verification_key:s},errors:{404:"Not Found",500:"Internal Server Error",501:"Not Implemented"}})}proofDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/proof/{proof_id}/delete",path:{proof_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}};var v=class{constructor(e){this.httpRequest=e}fd3Aaa7BControllerObtainToken(e){return this.httpRequest.request({method:"POST",url:"/api/token/pair",body:e,mediaType:"application/json"})}b87E0720ControllerRefreshToken(e){return this.httpRequest.request({method:"POST",url:"/api/token/refresh",body:e,mediaType:"application/json"})}d1C092ControllerVerifyToken(e){return this.httpRequest.request({method:"POST",url:"/api/token/verify",body:e,mediaType:"application/json"})}};var _=class{authorization;circuits;internal;proofs;token;request;constructor(e,r=L){this.request=new r({BASE:e?.BASE??"https://sindri.app",VERSION:e?.VERSION??"1.6.14",WITH_CREDENTIALS:e?.WITH_CREDENTIALS??!1,CREDENTIALS:e?.CREDENTIALS??"include",TOKEN:e?.TOKEN,USERNAME:e?.USERNAME,PASSWORD:e?.PASSWORD,HEADERS:e?.HEADERS,ENCODE_PATH:e?.ENCODE_PATH}),this.authorization=new x(this.request),this.circuits=new O(this.request),this.internal=new w(this.request),this.proofs=new q(this.request),this.token=new v(this.request)}};import N from"fs";import Q from"path";import fe from"env-paths";import D from"lodash";import{z as b}from"zod";var X=()=>{let t=fe("sindri",{suffix:""});return Q.join(t.config,"sindri.conf.json")},W=b.object({auth:b.nullable(b.object({apiKey:b.string(),apiKeyId:b.string(),apiKeyName:b.string(),baseUrl:b.string().url(),teamId:b.number(),teamSlug:b.string()})).default(null)}),de=W.parse({}),he=t=>{let e=X();if(N.existsSync(e)){t?.debug(`Loading config from "${e}".`);try{let r=N.readFileSync(e,{encoding:"utf-8"}),o=W.parse(JSON.parse(r));return t?.debug("Config loaded successfully."),o}catch(r){t?.warn(`The config schema in "${e}" is invalid and will not be used.
To remove it and start fresh, run:
    rm ${e}`),t?.debug(r)}}return t?.debug(`Config file "${e}" does not exist, initializing default config.`),D.cloneDeep(de)},H=class{_config;logger;constructor(e){this.logger=e,this.reload()}get auth(){return D.cloneDeep(this._config.auth)}get config(){return D.cloneDeep(this._config)}reload(){this._config=he(this.logger)}update(e){this.logger?.debug("Merging in config update:"),this.logger?.debug(e);let r=D.cloneDeep(this._config);D.merge(r,e),this._config=W.parse(r);let o=X(),i=Q.dirname(o);N.existsSync(i)||N.mkdirSync(i,{recursive:!0}),this.logger?.debug(`Writing merged config to "${o}":`,this._config),N.writeFileSync(o,JSON.stringify(this._config,null,2),{encoding:"utf-8"})}};import ye from"pino";import ge from"pino-pretty";var j=t=>{let e=ye(process.env.BROWSER_BUILD?{browser:{asObject:!0}}:ge({colorize:!0,destination:2,ignore:"hostname,pid",levelFirst:!1,sync:!0}));return e.level=t??!0?"silent":"info",e},vt=j();var $=class t{_client;_clientConfig;_config;logger;pollingInterval=1e3;constructor(e={}){this._client=new _,this._clientConfig=this._client.request.config;let r="v0.0.1-alpha.44";this._clientConfig.HEADERS={...this._clientConfig.HEADERS,"Sindri-Client":`sindri-js-sdk/${r}`},this.logger=j(),process.env.BROWSER_BUILD||(this._config=new H(this.logger)),this._clientConfig.logger=this.logger,this.authorize(e)}get apiKey(){return this._clientConfig.TOKEN&&typeof this._clientConfig.TOKEN!="string"?null:this._clientConfig.TOKEN||null}get baseUrl(){return this._clientConfig.BASE}get logLevel(){return this.logger.level}set logLevel(e){this.logger.level=e,this.logger.debug(`Set log level to "${this.logger.level}".`)}authorize(e){return process.env.BROWSER_BUILD?(this._clientConfig.BASE=e.baseUrl||"https://sindri.app",this._clientConfig.TOKEN=e.apiKey):(this._config.reload(),this._clientConfig.BASE=e.baseUrl||process.env.SINDRI_BASE_URL||this._config.auth?.baseUrl||this._clientConfig.BASE||"https://sindri.app",this._clientConfig.TOKEN=e.apiKey||process.env.SINDRI_API_KEY||this._config.auth?.apiKey),!!(this._clientConfig.BASE&&this._clientConfig.TOKEN)}create(e){return new t(e)}async createCircuit(e,r=["latest"]){let o=new T;r=typeof r=="string"?[r]:r??[];for(let p of r){if(!/^[-a-zA-Z0-9_.]+$/.test(p))throw new Error(`"${p}" is not a valid tag. Tags may only contain alphanumeric characters, underscores, hyphens, and periods.`);o.append("tags",p)}if(r.length===0&&o.append("tags",""),typeof e=="string"){if(process.env.BROWSER_BUILD)throw new Error("Specifying `project` as a path is not allowed in the browser build.");let p;try{p=await Re(e)}catch{throw new Error(`The "${e}" path does not exist or you do not have permission to access it.`)}if(p.isFile()){if(!/\.(zip|tar|tar\.gz|tgz)$/i.test(e))throw new Error("Only gzipped tarballs or zip files are supported.");let n=V.basename(e),l=await Y(e);o.append("files",new A([l],n))}else if(p.isDirectory()){let n=V.join(e,"sindri.json"),l;try{l=await Y(n,{encoding:"utf-8"})}catch{throw new Error(`Expected Sindri manifest file at "${n}" does not exist.`)}let g;try{g=JSON.parse(l)}catch{throw new Error(`Could not parse "${n}", is it valid JSON?`)}let d=g?.name;if(!d)throw new Error(`No circuit "name" field was found in "${n}", the manifest is invalid.`);let R=Ce.sync({follow:!0,ignoreFiles:[".sindriignore"],path:e}).filter(E=>!/(^|\/)\.git(\/|$)/.test(E)),h=V.basename(n);R.includes(h)||R.push(h);let y=`${d}.tar.gz`;R.sort((E,U)=>E.localeCompare(U));let C=Te.c({cwd:e,gzip:!0,onwarn:(E,U)=>{this.logger.warn(`While creating tarball: ${E} - ${U}`)},prefix:`${d}/`,sync:!0},R);o.append("files",new A([C.read()],y))}else throw new Error(`The "${e}" path is not a file or directory.`)}else if(Array.isArray(e)){if(!e.every(h=>h instanceof A))throw new Error("All entries in `project` must be `File` instances.");let p=e.find(h=>h.name==="sindri.json");if(!p)throw new Error("The `project` array must include a `sindri.json` file.");let n;try{n=JSON.parse(await p.text())}catch{throw new Error('Could not parse "sindri.json", is it valid JSON?')}let l=n?.name;if(!l)throw new Error('No circuit "name" field was found in "sindri.json", the manifest is invalid.');let g=new Se;e.sort((h,y)=>h.name.localeCompare(y.name));for(let h of e){let y=new Uint8Array(await h.arrayBuffer());await new Promise(C=>g.append(`${l}/${h.name}`,y,C))}let d=new Uint8Array(be.zip(g.out)),R=new A([d],`${l}.tar.gz`);process.env.BROWSER_BUILD,o.append("files",R)}let i=this._clientConfig.HEADERS;this._clientConfig.HEADERS={...i,"Content-Type":"multipart/form-data; boundary=----WebKitFormBoundary0buQ8d6EhWcs9X9d"};let a=await this._client.circuits.circuitCreate(o);this._clientConfig.HEADERS=i;let c=a.circuit_id,u;for(;u=await this._client.circuits.circuitDetail(c,!1),!(u.status==="Ready"||u.status==="Failed");)await new Promise(p=>setTimeout(p,this.pollingInterval));return u}async getAllCircuitProofs(e){return await this._client.circuits.circuitProofs(e)}async getAllCircuits(){return await this._client.circuits.circuitList()}async getCircuit(e){return await this._client.circuits.circuitDetail(e)}async getProof(e){return await this._client.proofs.proofDetail(e)}async proveCircuit(e,r,o=!1,i=!1){let s=await this._client.circuits.proofCreate(e,{perform_verify:o,proof_input:r}),a;for(;a=await this._client.proofs.proofDetail(s.proof_id,!0,!0,i,!0),!(a.status==="Ready"||a.status==="Failed");)await new Promise(c=>setTimeout(c,this.pollingInterval));return a}};var Qt=new $;export{Qt as default};
//# sourceMappingURL=index.mjs.map